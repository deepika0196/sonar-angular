import { Component, Inject } from '@angular/core';
import { MAT_DIALOG_DATA } from '@angular/material/dialog';
import { map, of } from 'rxjs';
import { FormBuilder, Validators } from '@angular/forms';
import * as i0 from "@angular/core";
import * as i1 from "@angular/material/dialog";
import * as i2 from "@angular/common";
import * as i3 from "@angular/forms";
import * as i4 from "@angular/material/datepicker";
import * as i5 from "@angular/material/form-field";
import * as i6 from "@angular/material/button";
import * as i7 from "@angular/material/input";
import * as i8 from "@angular/material/select";
import * as i9 from "@angular/material/core";
import * as i10 from "@angular/material/toolbar";
import * as i11 from "@angular/material/autocomplete";
import * as i12 from "@ngneat/transloco";
export class ArqPrefiltersDialogComponent {
    constructor(dialogRef, data) {
        this.dialogRef = dialogRef;
        this.data = data;
        this.idDatatable = this.data.idDatatable || '';
        this.prefilters = this.data.prefilters || [];
        this.refreshComboFn = this.data.refreshComboFn || function () { };
        this.fixedCol = (colId) => this.prefilters.filter((prefilter) => prefilter.key === colId) || this.prefilters[0];
        const controls = {};
        this.prefilters.forEach((prefilter) => (controls[prefilter.key] = ['', prefilter.isRequired ? [Validators.required] : []]));
        this.formGroup = new FormBuilder().group(controls);
    }
    displayFn(option) {
        return option?.description || '';
    }
    doFilter(evt, column) {
        if (evt.keyCode === 13) {
            return;
        }
        column.dataFn = column.dataFn.pipe(map(val => this.filter(val, this.formGroup.controls[column.key].value)));
    }
    optionSelected(column) {
        this.checkDependent(column);
    }
    filter(val, data) {
        if (!val)
            return [];
        return val.filter(item => item.description.toLowerCase().includes(this.getValue(data).toLowerCase()));
    }
    checkDependent(column) {
        const dependentCols = this.prefilters.filter(prefilter => prefilter.dependsOn && prefilter.dependsOn[0] === column.key);
        dependentCols.forEach(col => {
            const columnSchema = this.prefilters.find(colSchema => colSchema.key === col.key);
            if (!columnSchema)
                return;
            const dependentFilter = this.prefilters.find(prefilter => prefilter.key === columnSchema.key);
            if (dependentFilter)
                this.formGroup.controls[dependentFilter.key].reset();
            this.refrescarCombo({
                idColumn: col.key,
                idDatatable: this.idDatatable,
                queryParams: { [column.key]: this.getValue(this.formGroup.controls[column.key].value) }
            }, columnSchema);
        });
    }
    refrescarCombo(filterComboDynam, columnSchema) {
        this.refreshComboFn(filterComboDynam).subscribe((data) => {
            switch (columnSchema?.type?.toLowerCase()) {
                case 'select':
                case 'image':
                    columnSchema.data = data;
                    break;
                case 'autocomplete':
                    columnSchema.data = data;
                    columnSchema.dataFn = of(data);
                    break;
            }
        });
    }
    getValue(data) {
        return data.value || data;
    }
    onSubmit() {
        // Si hay un autocomplete, tiene que tener un objeto como value, si no lo reseteamos
        this.checkAutocompleteValue();
        // comprobamos el estado del formgroup
        if (this.formGroup.invalid) {
            this.refreshClientValidations(this.formGroup);
            return;
        }
        const addFilterForm = [];
        this.prefilters.forEach(prefilter => {
            if (this.formGroup.controls[prefilter.key]?.value) {
                if (prefilter.type === 'autocomplete') {
                    // en el autocomplete pasamos el objeto
                    addFilterForm.push({ data: [this.formGroup.controls[prefilter.key]?.value], column: prefilter });
                }
                else {
                    addFilterForm.push({
                        data: [this.getValue(this.formGroup.controls[prefilter.key]?.value)],
                        column: prefilter
                    });
                }
            }
        });
        this.dialogRef.close(addFilterForm);
    }
    checkAutocompleteValue() {
        this.prefilters
            .filter(prefilter => prefilter.type === 'autocomplete')
            .forEach(prefilter => {
            if (!this.formGroup.controls[prefilter.key].value?.value) {
                this.formGroup.controls[prefilter.key].reset();
                prefilter.dataFn = of(prefilter.data);
            }
        });
    }
    refreshClientValidations(form) {
        Object.keys(form.controls).forEach(keyControl => {
            if (form.controls[keyControl].status == 'INVALID') {
                form.controls[keyControl].updateValueAndValidity({ onlySelf: true });
                form.controls[keyControl].markAsTouched();
            }
        });
    }
}
ArqPrefiltersDialogComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ArqPrefiltersDialogComponent, deps: [{ token: i1.MatDialogRef }, { token: MAT_DIALOG_DATA }], target: i0.ɵɵFactoryTarget.Component });
ArqPrefiltersDialogComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: ArqPrefiltersDialogComponent, selector: "arq-prefilters-dialog", ngImport: i0, template: "<h2 mat-dialog-title>{{ 'DT-BA.PREFILTERS.TITLE' | transloco }}</h2>\r\n<form [formGroup]=\"this.formGroup\" (ngSubmit)=\"onSubmit()\">\r\n  <mat-dialog-content>\r\n    <ng-container *ngFor=\"let prefilter of data.prefilters; let i = index\">\r\n      <mat-toolbar class=\"dt-filter-toolbar\">\r\n        <mat-form-field subscriptSizing=\"dynamic\">\r\n          <mat-select placeholder=\"{{ 'DT-BA.COLUMN' | transloco }}\" [(value)]=\"data.prefilters[i]\">\r\n            <mat-option *ngFor=\"let col of fixedCol(prefilter.key)\" [value]=\"col\">{{ col.label }}</mat-option>\r\n          </mat-select>\r\n          <mat-hint\r\n            class=\"mat-warn\"\r\n            *ngIf=\"formGroup.controls[prefilter.key].touched && formGroup.controls[prefilter.key].errors\"></mat-hint>\r\n        </mat-form-field>\r\n\r\n        <ng-container *ngIf=\"prefilter\" [ngSwitch]=\"prefilter.type\">\r\n          <mat-form-field subscriptSizing=\"dynamic\">\r\n            <input\r\n              *ngSwitchDefault\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              matInput\r\n              type=\"text\"\r\n              [required]=\"true\"\r\n              placeholder=\"{{ 'DT-BA.FILTER' | transloco }}\" />\r\n            <input\r\n              *ngSwitchCase=\"'number'\"\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              matInput\r\n              type=\"number\"\r\n              placeholder=\"{{ 'DT-BA.FILTER' | transloco }}\" />\r\n            <mat-select *ngSwitchCase=\"'boolean'\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option [value]=\"true\">&#10003;</mat-option>\r\n              <mat-option [value]=\"false\">&#10005;</mat-option>\r\n            </mat-select>\r\n            <mat-select\r\n              *ngSwitchCase=\"'select'\"\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              (selectionChange)=\"optionSelected(prefilter)\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option *ngFor=\"let col of prefilter.data\" [value]=\"col.value\">\r\n                {{ col.description }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <ng-container *ngSwitchCase=\"'autocomplete'\">\r\n              <input\r\n                matInput\r\n                formControlName=\"{{ prefilter.key }}\"\r\n                [type]=\"'text'\"\r\n                [matAutocomplete]=\"auto\"\r\n                (keyup)=\"doFilter($event, prefilter)\" />\r\n              <mat-autocomplete\r\n                autoActiveFirstOption\r\n                #auto=\"matAutocomplete\"\r\n                class=\"arq-autocomplete\"\r\n                [displayWith]=\"displayFn\"\r\n                (optionSelected)=\"optionSelected(prefilter)\">\r\n                <mat-option *ngFor=\"let col of prefilter.dataFn | async\" [value]=\"col\">\r\n                  {{ col.description }}\r\n                </mat-option>\r\n              </mat-autocomplete>\r\n            </ng-container>\r\n            <ng-container *ngSwitchCase=\"'date'\">\r\n              <input\r\n                matInput\r\n                formControlName=\"{{ prefilter.key }}\"\r\n                placeholder=\"DD/MM/AAAA\"\r\n                [matDatepicker]=\"picker\"\r\n                (click)=\"picker.open()\" />\r\n              <mat-datepicker #picker></mat-datepicker>\r\n            </ng-container>\r\n            <mat-select *ngSwitchCase=\"'image'\" formControlName=\"{{ prefilter.key }}\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option *ngFor=\"let col of prefilter.data\" [value]=\"col.value\">\r\n                {{ col.description }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <mat-hint\r\n              style=\"color: red\"\r\n              *ngIf=\"formGroup.controls[prefilter.key].touched && formGroup.controls[prefilter.key].errors\">\r\n              {{ 'DT-BA.PREFILTERS.REQUIRED' | transloco }}\r\n            </mat-hint>\r\n          </mat-form-field>\r\n          <br />\r\n        </ng-container>\r\n      </mat-toolbar>\r\n    </ng-container>\r\n  </mat-dialog-content>\r\n\r\n  <mat-dialog-actions align=\"end\">\r\n    <button mat-button type=\"submit\">\r\n      {{ 'DT-BA.FILTERV' | transloco }}\r\n    </button>\r\n  </mat-dialog-actions>\r\n</form>\r\n", styles: [".dt-filter-toolbar{background-color:#fff}mat-toolbar button{margin-right:.5em}.dt-filter-toolbar mat-form-field,.dt-filter-toolbar button{margin-right:1em}.dt-filter-toolbar mat-form-field{margin-top:1.5em}.dt-filter-toolbar mat-form-field ::ng-deep .mdc-text-field--no-label:not(.mdc-text-field--outlined):not(.mdc-text-field--textarea) .mat-mdc-form-field-infix{padding-top:.8em!important;padding-bottom:.8em!important}.dt-filter-toolbar mat-form-field ::ng-deep .mat-mdc-form-field-infix{min-height:0!important}button{border-radius:0!important;height:2.6em;min-height:2.6em;font-size:16px}button:not([disabled]):hover{background-color:#0c556d;color:#fff;border-radius:0}button[disabled]{color:#1e1d1d;background-color:#acacac}\n"], dependencies: [{ kind: "directive", type: i2.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i2.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i2.NgSwitch, selector: "[ngSwitch]", inputs: ["ngSwitch"] }, { kind: "directive", type: i2.NgSwitchCase, selector: "[ngSwitchCase]", inputs: ["ngSwitchCase"] }, { kind: "directive", type: i2.NgSwitchDefault, selector: "[ngSwitchDefault]" }, { kind: "directive", type: i3.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i3.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i3.NumberValueAccessor, selector: "input[type=number][formControlName],input[type=number][formControl],input[type=number][ngModel]" }, { kind: "directive", type: i3.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i3.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i3.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }, { kind: "directive", type: i3.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "directive", type: i3.FormControlName, selector: "[formControlName]", inputs: ["formControlName", "disabled", "ngModel"], outputs: ["ngModelChange"] }, { kind: "component", type: i4.MatDatepicker, selector: "mat-datepicker", exportAs: ["matDatepicker"] }, { kind: "directive", type: i4.MatDatepickerInput, selector: "input[matDatepicker]", inputs: ["matDatepicker", "min", "max", "matDatepickerFilter"], exportAs: ["matDatepickerInput"] }, { kind: "component", type: i5.MatFormField, selector: "mat-form-field", inputs: ["hideRequiredMarker", "color", "floatLabel", "appearance", "subscriptSizing", "hintLabel"], exportAs: ["matFormField"] }, { kind: "directive", type: i5.MatHint, selector: "mat-hint", inputs: ["align", "id"] }, { kind: "component", type: i6.MatButton, selector: "    button[mat-button], button[mat-raised-button], button[mat-flat-button],    button[mat-stroked-button]  ", inputs: ["disabled", "disableRipple", "color"], exportAs: ["matButton"] }, { kind: "directive", type: i7.MatInput, selector: "input[matInput], textarea[matInput], select[matNativeControl],      input[matNativeControl], textarea[matNativeControl]", inputs: ["disabled", "id", "placeholder", "name", "required", "type", "errorStateMatcher", "aria-describedby", "value", "readonly"], exportAs: ["matInput"] }, { kind: "component", type: i8.MatSelect, selector: "mat-select", inputs: ["disabled", "disableRipple", "tabIndex", "hideSingleSelectionIndicator"], exportAs: ["matSelect"] }, { kind: "component", type: i9.MatOption, selector: "mat-option", exportAs: ["matOption"] }, { kind: "component", type: i10.MatToolbar, selector: "mat-toolbar", inputs: ["color"], exportAs: ["matToolbar"] }, { kind: "component", type: i11.MatAutocomplete, selector: "mat-autocomplete", inputs: ["disableRipple", "hideSingleSelectionIndicator"], exportAs: ["matAutocomplete"] }, { kind: "directive", type: i11.MatAutocompleteTrigger, selector: "input[matAutocomplete], textarea[matAutocomplete]", exportAs: ["matAutocompleteTrigger"] }, { kind: "directive", type: i1.MatDialogTitle, selector: "[mat-dialog-title], [matDialogTitle]", inputs: ["id"], exportAs: ["matDialogTitle"] }, { kind: "directive", type: i1.MatDialogContent, selector: "[mat-dialog-content], mat-dialog-content, [matDialogContent]" }, { kind: "directive", type: i1.MatDialogActions, selector: "[mat-dialog-actions], mat-dialog-actions, [matDialogActions]", inputs: ["align"] }, { kind: "pipe", type: i2.AsyncPipe, name: "async" }, { kind: "pipe", type: i12.TranslocoPipe, name: "transloco" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ArqPrefiltersDialogComponent, decorators: [{
            type: Component,
            args: [{ selector: 'arq-prefilters-dialog', template: "<h2 mat-dialog-title>{{ 'DT-BA.PREFILTERS.TITLE' | transloco }}</h2>\r\n<form [formGroup]=\"this.formGroup\" (ngSubmit)=\"onSubmit()\">\r\n  <mat-dialog-content>\r\n    <ng-container *ngFor=\"let prefilter of data.prefilters; let i = index\">\r\n      <mat-toolbar class=\"dt-filter-toolbar\">\r\n        <mat-form-field subscriptSizing=\"dynamic\">\r\n          <mat-select placeholder=\"{{ 'DT-BA.COLUMN' | transloco }}\" [(value)]=\"data.prefilters[i]\">\r\n            <mat-option *ngFor=\"let col of fixedCol(prefilter.key)\" [value]=\"col\">{{ col.label }}</mat-option>\r\n          </mat-select>\r\n          <mat-hint\r\n            class=\"mat-warn\"\r\n            *ngIf=\"formGroup.controls[prefilter.key].touched && formGroup.controls[prefilter.key].errors\"></mat-hint>\r\n        </mat-form-field>\r\n\r\n        <ng-container *ngIf=\"prefilter\" [ngSwitch]=\"prefilter.type\">\r\n          <mat-form-field subscriptSizing=\"dynamic\">\r\n            <input\r\n              *ngSwitchDefault\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              matInput\r\n              type=\"text\"\r\n              [required]=\"true\"\r\n              placeholder=\"{{ 'DT-BA.FILTER' | transloco }}\" />\r\n            <input\r\n              *ngSwitchCase=\"'number'\"\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              matInput\r\n              type=\"number\"\r\n              placeholder=\"{{ 'DT-BA.FILTER' | transloco }}\" />\r\n            <mat-select *ngSwitchCase=\"'boolean'\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option [value]=\"true\">&#10003;</mat-option>\r\n              <mat-option [value]=\"false\">&#10005;</mat-option>\r\n            </mat-select>\r\n            <mat-select\r\n              *ngSwitchCase=\"'select'\"\r\n              formControlName=\"{{ prefilter.key }}\"\r\n              (selectionChange)=\"optionSelected(prefilter)\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option *ngFor=\"let col of prefilter.data\" [value]=\"col.value\">\r\n                {{ col.description }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <ng-container *ngSwitchCase=\"'autocomplete'\">\r\n              <input\r\n                matInput\r\n                formControlName=\"{{ prefilter.key }}\"\r\n                [type]=\"'text'\"\r\n                [matAutocomplete]=\"auto\"\r\n                (keyup)=\"doFilter($event, prefilter)\" />\r\n              <mat-autocomplete\r\n                autoActiveFirstOption\r\n                #auto=\"matAutocomplete\"\r\n                class=\"arq-autocomplete\"\r\n                [displayWith]=\"displayFn\"\r\n                (optionSelected)=\"optionSelected(prefilter)\">\r\n                <mat-option *ngFor=\"let col of prefilter.dataFn | async\" [value]=\"col\">\r\n                  {{ col.description }}\r\n                </mat-option>\r\n              </mat-autocomplete>\r\n            </ng-container>\r\n            <ng-container *ngSwitchCase=\"'date'\">\r\n              <input\r\n                matInput\r\n                formControlName=\"{{ prefilter.key }}\"\r\n                placeholder=\"DD/MM/AAAA\"\r\n                [matDatepicker]=\"picker\"\r\n                (click)=\"picker.open()\" />\r\n              <mat-datepicker #picker></mat-datepicker>\r\n            </ng-container>\r\n            <mat-select *ngSwitchCase=\"'image'\" formControlName=\"{{ prefilter.key }}\">\r\n              <mat-option [value]=\"null\"></mat-option>\r\n              <mat-option *ngFor=\"let col of prefilter.data\" [value]=\"col.value\">\r\n                {{ col.description }}\r\n              </mat-option>\r\n            </mat-select>\r\n            <mat-hint\r\n              style=\"color: red\"\r\n              *ngIf=\"formGroup.controls[prefilter.key].touched && formGroup.controls[prefilter.key].errors\">\r\n              {{ 'DT-BA.PREFILTERS.REQUIRED' | transloco }}\r\n            </mat-hint>\r\n          </mat-form-field>\r\n          <br />\r\n        </ng-container>\r\n      </mat-toolbar>\r\n    </ng-container>\r\n  </mat-dialog-content>\r\n\r\n  <mat-dialog-actions align=\"end\">\r\n    <button mat-button type=\"submit\">\r\n      {{ 'DT-BA.FILTERV' | transloco }}\r\n    </button>\r\n  </mat-dialog-actions>\r\n</form>\r\n", styles: [".dt-filter-toolbar{background-color:#fff}mat-toolbar button{margin-right:.5em}.dt-filter-toolbar mat-form-field,.dt-filter-toolbar button{margin-right:1em}.dt-filter-toolbar mat-form-field{margin-top:1.5em}.dt-filter-toolbar mat-form-field ::ng-deep .mdc-text-field--no-label:not(.mdc-text-field--outlined):not(.mdc-text-field--textarea) .mat-mdc-form-field-infix{padding-top:.8em!important;padding-bottom:.8em!important}.dt-filter-toolbar mat-form-field ::ng-deep .mat-mdc-form-field-infix{min-height:0!important}button{border-radius:0!important;height:2.6em;min-height:2.6em;font-size:16px}button:not([disabled]):hover{background-color:#0c556d;color:#fff;border-radius:0}button[disabled]{color:#1e1d1d;background-color:#acacac}\n"] }]
        }], ctorParameters: function () { return [{ type: i1.MatDialogRef }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [MAT_DIALOG_DATA]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJlZmlsdGVycy1kaWFsb2cuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vYXJxLXNkay9zcmMvbGliL2NvbXBvbmVudHMvYXJxLWR0LWJ1c3F1ZWRhLWF2YW56YWRhL2RpYWxvZ3MvcHJlZmlsdGVycy9wcmVmaWx0ZXJzLWRpYWxvZy5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9hcnEtc2RrL3NyYy9saWIvY29tcG9uZW50cy9hcnEtZHQtYnVzcXVlZGEtYXZhbnphZGEvZGlhbG9ncy9wcmVmaWx0ZXJzL3ByZWZpbHRlcnMtZGlhbG9nLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFhLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxlQUFlLEVBQWdCLE1BQU0sMEJBQTBCLENBQUM7QUFDekUsT0FBTyxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFLM0MsT0FBTyxFQUFtQixXQUFXLEVBQXFCLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7Ozs7OztBQU83RixNQUFNLE9BQU8sNEJBQTRCO0lBTXZDLFlBQ1MsU0FBcUQsRUFFckQsSUFJTjtRQU5NLGNBQVMsR0FBVCxTQUFTLENBQTRDO1FBRXJELFNBQUksR0FBSixJQUFJLENBSVY7UUFaSSxnQkFBVyxHQUFXLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztRQUNsRCxlQUFVLEdBQWdDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLEVBQUUsQ0FBQztRQUVyRSxtQkFBYyxHQUFhLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxJQUFJLGNBQW1CLENBQUMsQ0FBQztRQW1CNUUsYUFBUSxHQUFHLENBQUMsS0FBYSxFQUErQixFQUFFLENB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QUFHLEVBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSyxDQUFDLENBQUM7YUFDeEM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyx3QkFBd0IsQ0FBQyxJQUFlO1FBQzlDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUM5QyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsTUFBTSxJQUFJLFNBQVMsRUFBRTtnQkFDakQsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2dCQUNyRSxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsRUFBRSxDQUFDO2FBQzNDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzt5SEF0SVUsNEJBQTRCLDhDQVE3QixlQUFlOzZHQVJkLDRCQUE0Qiw2RENkekMsdXlJQThGQTsyRkRoRmEsNEJBQTRCO2tCQUx4QyxTQUFTOytCQUNFLHVCQUF1Qjs7MEJBWTlCLE1BQU07MkJBQUMsZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgSW5qZWN0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTUFUX0RJQUxPR19EQVRBLCBNYXREaWFsb2dSZWYgfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9kaWFsb2cnO1xyXG5pbXBvcnQgeyBtYXAsIG9mLCBTdWJzY3JpYmVyIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBBcnFEYXRhdGFibGVDb2x1bW5zU2NoZW1hIH0gZnJvbSAnLi4vLi4vLi4vYXJxLWRhdGF0YWJsZS9hcnEtZGF0YXRhYmxlLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IEFycURUQnVzcXVlZGFBdmFuemFkYUNvbWJvRHluYW0gfSBmcm9tICcuLi8uLi9hcnEtZHQtYnVzcXVlZGEtYXZhbnphZGEuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQXJxTGlzdCB9IGZyb20gJy4uLy4uLy4uLy4uL2ludGVyZmFjZXMvYXJxLWxpc3QuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgQWJzdHJhY3RDb250cm9sLCBGb3JtQnVpbGRlciwgRm9ybUdyb3VwLCBOZ0Zvcm0sIFZhbGlkYXRvcnMgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2FycS1wcmVmaWx0ZXJzLWRpYWxvZycsXHJcbiAgdGVtcGxhdGVVcmw6ICdwcmVmaWx0ZXJzLWRpYWxvZy5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJ3ByZWZpbHRlcnMtZGlhbG9nLmNvbXBvbmVudC5zY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIEFycVByZWZpbHRlcnNEaWFsb2dDb21wb25lbnQge1xyXG4gIHB1YmxpYyBpZERhdGF0YWJsZTogc3RyaW5nID0gdGhpcy5kYXRhLmlkRGF0YXRhYmxlIHx8ICcnO1xyXG4gIHB1YmxpYyBwcmVmaWx0ZXJzOiBBcnFEYXRhdGFibGVDb2x1bW5zU2NoZW1hW10gPSB0aGlzLmRhdGEucHJlZmlsdGVycyB8fCBbXTtcclxuICBwdWJsaWMgZm9ybUdyb3VwITogRm9ybUdyb3VwO1xyXG4gIHB1YmxpYyByZWZyZXNoQ29tYm9GbjogRnVuY3Rpb24gPSB0aGlzLmRhdGEucmVmcmVzaENvbWJvRm4gfHwgZnVuY3Rpb24gKCk6IHZvaWQge307XHJcblxyXG4gIHB1YmxpYyBjb25zdHJ1Y3RvcihcclxuICAgIHB1YmxpYyBkaWFsb2dSZWY6IE1hdERpYWxvZ1JlZjxBcnFQcmVmaWx0ZXJzRGlhbG9nQ29tcG9uZW50PixcclxuICAgIEBJbmplY3QoTUFUX0RJQUxPR19EQVRBKVxyXG4gICAgcHVibGljIGRhdGE6IHtcclxuICAgICAgaWREYXRhdGFibGU6IHN0cmluZztcclxuICAgICAgcHJlZmlsdGVyczogQXJxRGF0YXRhYmxlQ29sdW1uc1NjaGVtYVtdO1xyXG4gICAgICByZWZyZXNoQ29tYm9GbjogRnVuY3Rpb247XHJcbiAgICB9XHJcbiAgKSB7XHJcbiAgICBjb25zdCBjb250cm9sczogYW55ID0ge307XHJcbiAgICB0aGlzLnByZWZpbHRlcnMuZm9yRWFjaChcclxuICAgICAgKHByZWZpbHRlcjogQXJxRGF0YXRhYmxlQ29sdW1uc1NjaGVtYSkgPT5cclxuICAgICAgICAoY29udHJvbHNbcHJlZmlsdGVyLmtleV0gPSBbJycsIHByZWZpbHRlci5pc1JlcXVpcmVkID8gW1ZhbGlkYXRvcnMucmVxdWlyZWRdIDogW11dKVxyXG4gICAgKTtcclxuICAgIHRoaXMuZm9ybUdyb3VwID0gbmV3IEZvcm1CdWlsZGVyKCkuZ3JvdXAoY29udHJvbHMpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGZpeGVkQ29sID0gKGNvbElkOiBzdHJpbmcpOiBBcnFEYXRhdGFibGVDb2x1bW5zU2NoZW1hW10gPT5cclxuICAgIHRoaXMucHJlZmlsdGVycy5maWx0ZXIoKHByZWZpbHRlcjogQXJxRGF0YXRhYmxlQ29sdW1uc1NjaGVtYSkgPT4gcHJlZmlsdGVyLmtleSA9PT0gY29sSWQpIHx8IHRoaXMucHJlZmlsdGVyc1swXTtcclxuXHJcbiAgcHVibGljIGRpc3BsYXlGbihvcHRpb246IGFueSk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gb3B0aW9uPy5kZXNjcmlwdGlvbiB8fCAnJztcclxuICB9XHJcblxyXG4gIHB1YmxpYyBkb0ZpbHRlcihldnQ6IGFueSwgY29sdW1uOiBBcnFEYXRhdGFibGVDb2x1bW5zU2NoZW1hKTogdm9pZCB7XHJcbiAgICBpZiAoZXZ0LmtleUNvZGUgPT09IDEzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbHVtbi5kYXRhRm4gPSBjb2x1bW4uZGF0YUZuIS5waXBlKG1hcCh2YWwgPT4gdGhpcy5maWx0ZXIodmFsLCB0aGlzLmZvcm1Hcm91cC5jb250cm9sc1tjb2x1bW4ua2V5XS52YWx1ZSkpKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBvcHRpb25TZWxlY3RlZChjb2x1bW46IEFycURhdGF0YWJsZUNvbHVtbnNTY2hlbWEpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tEZXBlbmRlbnQoY29sdW1uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmlsdGVyKHZhbDogQXJxTGlzdFtdLCBkYXRhOiBhbnkpOiBBcnFMaXN0W10ge1xyXG4gICAgaWYgKCF2YWwpIHJldHVybiBbXTtcclxuICAgIHJldHVybiB2YWwuZmlsdGVyKGl0ZW0gPT4gaXRlbS5kZXNjcmlwdGlvbi50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRoaXMuZ2V0VmFsdWUoZGF0YSkudG9Mb3dlckNhc2UoKSkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjaGVja0RlcGVuZGVudChjb2x1bW46IEFycURhdGF0YWJsZUNvbHVtbnNTY2hlbWEpOiB2b2lkIHtcclxuICAgIGNvbnN0IGRlcGVuZGVudENvbHM6IEFycURhdGF0YWJsZUNvbHVtbnNTY2hlbWFbXSA9IHRoaXMucHJlZmlsdGVycy5maWx0ZXIoXHJcbiAgICAgIHByZWZpbHRlciA9PiBwcmVmaWx0ZXIuZGVwZW5kc09uICYmIHByZWZpbHRlci5kZXBlbmRzT25bMF0gPT09IGNvbHVtbi5rZXlcclxuICAgICk7XHJcbiAgICBkZXBlbmRlbnRDb2xzLmZvckVhY2goY29sID0+IHtcclxuICAgICAgY29uc3QgY29sdW1uU2NoZW1hID0gdGhpcy5wcmVmaWx0ZXJzLmZpbmQoY29sU2NoZW1hID0+IGNvbFNjaGVtYS5rZXkgPT09IGNvbC5rZXkpO1xyXG4gICAgICBpZiAoIWNvbHVtblNjaGVtYSkgcmV0dXJuO1xyXG4gICAgICBjb25zdCBkZXBlbmRlbnRGaWx0ZXI6IEFycURhdGF0YWJsZUNvbHVtbnNTY2hlbWEgfCB1bmRlZmluZWQgPSB0aGlzLnByZWZpbHRlcnMuZmluZChcclxuICAgICAgICBwcmVmaWx0ZXIgPT4gcHJlZmlsdGVyLmtleSA9PT0gY29sdW1uU2NoZW1hLmtleVxyXG4gICAgICApO1xyXG4gICAgICBpZiAoZGVwZW5kZW50RmlsdGVyKSB0aGlzLmZvcm1Hcm91cC5jb250cm9sc1tkZXBlbmRlbnRGaWx0ZXIua2V5XS5yZXNldCgpO1xyXG4gICAgICB0aGlzLnJlZnJlc2NhckNvbWJvKFxyXG4gICAgICAgIHtcclxuICAgICAgICAgIGlkQ29sdW1uOiBjb2wua2V5LFxyXG4gICAgICAgICAgaWREYXRhdGFibGU6IHRoaXMuaWREYXRhdGFibGUsXHJcbiAgICAgICAgICBxdWVyeVBhcmFtczogeyBbY29sdW1uLmtleV06IHRoaXMuZ2V0VmFsdWUodGhpcy5mb3JtR3JvdXAuY29udHJvbHNbY29sdW1uLmtleV0udmFsdWUpIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIGNvbHVtblNjaGVtYVxyXG4gICAgICApO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlZnJlc2NhckNvbWJvKFxyXG4gICAgZmlsdGVyQ29tYm9EeW5hbTogQXJxRFRCdXNxdWVkYUF2YW56YWRhQ29tYm9EeW5hbSxcclxuICAgIGNvbHVtblNjaGVtYTogQXJxRGF0YXRhYmxlQ29sdW1uc1NjaGVtYVxyXG4gICk6IHZvaWQge1xyXG4gICAgdGhpcy5yZWZyZXNoQ29tYm9GbihmaWx0ZXJDb21ib0R5bmFtKS5zdWJzY3JpYmUoKGRhdGE6IEFycUxpc3RbXSkgPT4ge1xyXG4gICAgICBzd2l0Y2ggKGNvbHVtblNjaGVtYT8udHlwZT8udG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICAgIGNhc2UgJ3NlbGVjdCc6XHJcbiAgICAgICAgY2FzZSAnaW1hZ2UnOlxyXG4gICAgICAgICAgY29sdW1uU2NoZW1hIS5kYXRhID0gZGF0YTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgJ2F1dG9jb21wbGV0ZSc6XHJcbiAgICAgICAgICBjb2x1bW5TY2hlbWEhLmRhdGEgPSBkYXRhO1xyXG4gICAgICAgICAgY29sdW1uU2NoZW1hIS5kYXRhRm4gPSBvZihkYXRhKTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0VmFsdWUoZGF0YTogYW55KTogc3RyaW5nIHtcclxuICAgIHJldHVybiBkYXRhLnZhbHVlIHx8IGRhdGE7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgb25TdWJtaXQoKTogdm9pZCB7XHJcbiAgICAvLyBTaSBoYXkgdW4gYXV0b2NvbXBsZXRlLCB0aWVuZSBxdWUgdGVuZXIgdW4gb2JqZXRvIGNvbW8gdmFsdWUsIHNpIG5vIGxvIHJlc2V0ZWFtb3NcclxuICAgIHRoaXMuY2hlY2tBdXRvY29tcGxldGVWYWx1ZSgpO1xyXG4gICAgLy8gY29tcHJvYmFtb3MgZWwgZXN0YWRvIGRlbCBmb3JtZ3JvdXBcclxuICAgIGlmICh0aGlzLmZvcm1Hcm91cC5pbnZhbGlkKSB7XHJcbiAgICAgIHRoaXMucmVmcmVzaENsaWVudFZhbGlkYXRpb25zKHRoaXMuZm9ybUdyb3VwKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFkZEZpbHRlckZvcm06IHsgZGF0YTogQXJyYXk8c3RyaW5nPjsgY29sdW1uOiBBcnFEYXRhdGFibGVDb2x1bW5zU2NoZW1hIHwgbnVsbCB9W10gPSBbXTtcclxuICAgIHRoaXMucHJlZmlsdGVycy5mb3JFYWNoKHByZWZpbHRlciA9PiB7XHJcbiAgICAgIGlmICh0aGlzLmZvcm1Hcm91cC5jb250cm9sc1twcmVmaWx0ZXIua2V5XT8udmFsdWUpIHtcclxuICAgICAgICBpZiAocHJlZmlsdGVyLnR5cGUgPT09ICdhdXRvY29tcGxldGUnKSB7XHJcbiAgICAgICAgICAvLyBlbiBlbCBhdXRvY29tcGxldGUgcGFzYW1vcyBlbCBvYmpldG9cclxuICAgICAgICAgIGFkZEZpbHRlckZvcm0ucHVzaCh7IGRhdGE6IFt0aGlzLmZvcm1Hcm91cC5jb250cm9sc1twcmVmaWx0ZXIua2V5XT8udmFsdWVdLCBjb2x1bW46IHByZWZpbHRlciB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgYWRkRmlsdGVyRm9ybS5wdXNoKHtcclxuICAgICAgICAgICAgZGF0YTogW3RoaXMuZ2V0VmFsdWUodGhpcy5mb3JtR3JvdXAuY29udHJvbHNbcHJlZmlsdGVyLmtleV0/LnZhbHVlKV0sXHJcbiAgICAgICAgICAgIGNvbHVtbjogcHJlZmlsdGVyXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gICAgdGhpcy5kaWFsb2dSZWYuY2xvc2UoYWRkRmlsdGVyRm9ybSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrQXV0b2NvbXBsZXRlVmFsdWUoKTogdm9pZCB7XHJcbiAgICB0aGlzLnByZWZpbHRlcnNcclxuICAgICAgLmZpbHRlcihwcmVmaWx0ZXIgPT4gcHJlZmlsdGVyLnR5cGUgPT09ICdhdXRvY29tcGxldGUnKVxyXG4gICAgICAuZm9yRWFjaChwcmVmaWx0ZXIgPT4ge1xyXG4gICAgICAgIGlmICghdGhpcy5mb3JtR3JvdXAuY29udHJvbHNbcHJlZmlsdGVyLmtleV0udmFsdWU/LnZhbHVlKSB7XHJcbiAgICAgICAgICB0aGlzLmZvcm1Hcm91cC5jb250cm9sc1twcmVmaWx0ZXIua2V5XS5yZXNldCgpO1xyXG4gICAgICAgICAgcHJlZmlsdGVyLmRhdGFGbiA9IG9mKHByZWZpbHRlci5kYXRhISk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVmcmVzaENsaWVudFZhbGlkYXRpb25zKGZvcm06IEZvcm1Hcm91cCk6IHZvaWQge1xyXG4gICAgT2JqZWN0LmtleXMoZm9ybS5jb250cm9scykuZm9yRWFjaChrZXlDb250cm9sID0+IHtcclxuICAgICAgaWYgKGZvcm0uY29udHJvbHNba2V5Q29udHJvbF0uc3RhdHVzID09ICdJTlZBTElEJykge1xyXG4gICAgICAgIGZvcm0uY29udHJvbHNba2V5Q29udHJvbF0udXBkYXRlVmFsdWVBbmRWYWxpZGl0eSh7IG9ubHlTZWxmOiB0cnVlIH0pO1xyXG4gICAgICAgIGZvcm0uY29udHJvbHNba2V5Q29udHJvbF0ubWFya0FzVG91Y2hlZCgpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIiwiPGgyIG1hdC1kaWFsb2ctdGl0bGU+e3sgJ0RULUJBLlBSRUZJTFRFUlMuVElUTEUnIHwgdHJhbnNsb2NvIH19PC9oMj5cclxuPGZvcm0gW2Zvcm1Hcm91cF09XCJ0aGlzLmZvcm1Hcm91cFwiIChuZ1N1Ym1pdCk9XCJvblN1Ym1pdCgpXCI+XHJcbiAgPG1hdC1kaWFsb2ctY29udGVudD5cclxuICAgIDxuZy1jb250YWluZXIgKm5nRm9yPVwibGV0IHByZWZpbHRlciBvZiBkYXRhLnByZWZpbHRlcnM7IGxldCBpID0gaW5kZXhcIj5cclxuICAgICAgPG1hdC10b29sYmFyIGNsYXNzPVwiZHQtZmlsdGVyLXRvb2xiYXJcIj5cclxuICAgICAgICA8bWF0LWZvcm0tZmllbGQgc3Vic2NyaXB0U2l6aW5nPVwiZHluYW1pY1wiPlxyXG4gICAgICAgICAgPG1hdC1zZWxlY3QgcGxhY2Vob2xkZXI9XCJ7eyAnRFQtQkEuQ09MVU1OJyB8IHRyYW5zbG9jbyB9fVwiIFsodmFsdWUpXT1cImRhdGEucHJlZmlsdGVyc1tpXVwiPlxyXG4gICAgICAgICAgICA8bWF0LW9wdGlvbiAqbmdGb3I9XCJsZXQgY29sIG9mIGZpeGVkQ29sKHByZWZpbHRlci5rZXkpXCIgW3ZhbHVlXT1cImNvbFwiPnt7IGNvbC5sYWJlbCB9fTwvbWF0LW9wdGlvbj5cclxuICAgICAgICAgIDwvbWF0LXNlbGVjdD5cclxuICAgICAgICAgIDxtYXQtaGludFxyXG4gICAgICAgICAgICBjbGFzcz1cIm1hdC13YXJuXCJcclxuICAgICAgICAgICAgKm5nSWY9XCJmb3JtR3JvdXAuY29udHJvbHNbcHJlZmlsdGVyLmtleV0udG91Y2hlZCAmJiBmb3JtR3JvdXAuY29udHJvbHNbcHJlZmlsdGVyLmtleV0uZXJyb3JzXCI+PC9tYXQtaGludD5cclxuICAgICAgICA8L21hdC1mb3JtLWZpZWxkPlxyXG5cclxuICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwicHJlZmlsdGVyXCIgW25nU3dpdGNoXT1cInByZWZpbHRlci50eXBlXCI+XHJcbiAgICAgICAgICA8bWF0LWZvcm0tZmllbGQgc3Vic2NyaXB0U2l6aW5nPVwiZHluYW1pY1wiPlxyXG4gICAgICAgICAgICA8aW5wdXRcclxuICAgICAgICAgICAgICAqbmdTd2l0Y2hEZWZhdWx0XHJcbiAgICAgICAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVwie3sgcHJlZmlsdGVyLmtleSB9fVwiXHJcbiAgICAgICAgICAgICAgbWF0SW5wdXRcclxuICAgICAgICAgICAgICB0eXBlPVwidGV4dFwiXHJcbiAgICAgICAgICAgICAgW3JlcXVpcmVkXT1cInRydWVcIlxyXG4gICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwie3sgJ0RULUJBLkZJTFRFUicgfCB0cmFuc2xvY28gfX1cIiAvPlxyXG4gICAgICAgICAgICA8aW5wdXRcclxuICAgICAgICAgICAgICAqbmdTd2l0Y2hDYXNlPVwiJ251bWJlcidcIlxyXG4gICAgICAgICAgICAgIGZvcm1Db250cm9sTmFtZT1cInt7IHByZWZpbHRlci5rZXkgfX1cIlxyXG4gICAgICAgICAgICAgIG1hdElucHV0XHJcbiAgICAgICAgICAgICAgdHlwZT1cIm51bWJlclwiXHJcbiAgICAgICAgICAgICAgcGxhY2Vob2xkZXI9XCJ7eyAnRFQtQkEuRklMVEVSJyB8IHRyYW5zbG9jbyB9fVwiIC8+XHJcbiAgICAgICAgICAgIDxtYXQtc2VsZWN0ICpuZ1N3aXRjaENhc2U9XCInYm9vbGVhbidcIj5cclxuICAgICAgICAgICAgICA8bWF0LW9wdGlvbiBbdmFsdWVdPVwibnVsbFwiPjwvbWF0LW9wdGlvbj5cclxuICAgICAgICAgICAgICA8bWF0LW9wdGlvbiBbdmFsdWVdPVwidHJ1ZVwiPiYjMTAwMDM7PC9tYXQtb3B0aW9uPlxyXG4gICAgICAgICAgICAgIDxtYXQtb3B0aW9uIFt2YWx1ZV09XCJmYWxzZVwiPiYjMTAwMDU7PC9tYXQtb3B0aW9uPlxyXG4gICAgICAgICAgICA8L21hdC1zZWxlY3Q+XHJcbiAgICAgICAgICAgIDxtYXQtc2VsZWN0XHJcbiAgICAgICAgICAgICAgKm5nU3dpdGNoQ2FzZT1cIidzZWxlY3QnXCJcclxuICAgICAgICAgICAgICBmb3JtQ29udHJvbE5hbWU9XCJ7eyBwcmVmaWx0ZXIua2V5IH19XCJcclxuICAgICAgICAgICAgICAoc2VsZWN0aW9uQ2hhbmdlKT1cIm9wdGlvblNlbGVjdGVkKHByZWZpbHRlcilcIj5cclxuICAgICAgICAgICAgICA8bWF0LW9wdGlvbiBbdmFsdWVdPVwibnVsbFwiPjwvbWF0LW9wdGlvbj5cclxuICAgICAgICAgICAgICA8bWF0LW9wdGlvbiAqbmdGb3I9XCJsZXQgY29sIG9mIHByZWZpbHRlci5kYXRhXCIgW3ZhbHVlXT1cImNvbC52YWx1ZVwiPlxyXG4gICAgICAgICAgICAgICAge3sgY29sLmRlc2NyaXB0aW9uIH19XHJcbiAgICAgICAgICAgICAgPC9tYXQtb3B0aW9uPlxyXG4gICAgICAgICAgICA8L21hdC1zZWxlY3Q+XHJcbiAgICAgICAgICAgIDxuZy1jb250YWluZXIgKm5nU3dpdGNoQ2FzZT1cIidhdXRvY29tcGxldGUnXCI+XHJcbiAgICAgICAgICAgICAgPGlucHV0XHJcbiAgICAgICAgICAgICAgICBtYXRJbnB1dFxyXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVwie3sgcHJlZmlsdGVyLmtleSB9fVwiXHJcbiAgICAgICAgICAgICAgICBbdHlwZV09XCIndGV4dCdcIlxyXG4gICAgICAgICAgICAgICAgW21hdEF1dG9jb21wbGV0ZV09XCJhdXRvXCJcclxuICAgICAgICAgICAgICAgIChrZXl1cCk9XCJkb0ZpbHRlcigkZXZlbnQsIHByZWZpbHRlcilcIiAvPlxyXG4gICAgICAgICAgICAgIDxtYXQtYXV0b2NvbXBsZXRlXHJcbiAgICAgICAgICAgICAgICBhdXRvQWN0aXZlRmlyc3RPcHRpb25cclxuICAgICAgICAgICAgICAgICNhdXRvPVwibWF0QXV0b2NvbXBsZXRlXCJcclxuICAgICAgICAgICAgICAgIGNsYXNzPVwiYXJxLWF1dG9jb21wbGV0ZVwiXHJcbiAgICAgICAgICAgICAgICBbZGlzcGxheVdpdGhdPVwiZGlzcGxheUZuXCJcclxuICAgICAgICAgICAgICAgIChvcHRpb25TZWxlY3RlZCk9XCJvcHRpb25TZWxlY3RlZChwcmVmaWx0ZXIpXCI+XHJcbiAgICAgICAgICAgICAgICA8bWF0LW9wdGlvbiAqbmdGb3I9XCJsZXQgY29sIG9mIHByZWZpbHRlci5kYXRhRm4gfCBhc3luY1wiIFt2YWx1ZV09XCJjb2xcIj5cclxuICAgICAgICAgICAgICAgICAge3sgY29sLmRlc2NyaXB0aW9uIH19XHJcbiAgICAgICAgICAgICAgICA8L21hdC1vcHRpb24+XHJcbiAgICAgICAgICAgICAgPC9tYXQtYXV0b2NvbXBsZXRlPlxyXG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdTd2l0Y2hDYXNlPVwiJ2RhdGUnXCI+XHJcbiAgICAgICAgICAgICAgPGlucHV0XHJcbiAgICAgICAgICAgICAgICBtYXRJbnB1dFxyXG4gICAgICAgICAgICAgICAgZm9ybUNvbnRyb2xOYW1lPVwie3sgcHJlZmlsdGVyLmtleSB9fVwiXHJcbiAgICAgICAgICAgICAgICBwbGFjZWhvbGRlcj1cIkREL01NL0FBQUFcIlxyXG4gICAgICAgICAgICAgICAgW21hdERhdGVwaWNrZXJdPVwicGlja2VyXCJcclxuICAgICAgICAgICAgICAgIChjbGljayk9XCJwaWNrZXIub3BlbigpXCIgLz5cclxuICAgICAgICAgICAgICA8bWF0LWRhdGVwaWNrZXIgI3BpY2tlcj48L21hdC1kYXRlcGlja2VyPlxyXG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICAgICAgPG1hdC1zZWxlY3QgKm5nU3dpdGNoQ2FzZT1cIidpbWFnZSdcIiBmb3JtQ29udHJvbE5hbWU9XCJ7eyBwcmVmaWx0ZXIua2V5IH19XCI+XHJcbiAgICAgICAgICAgICAgPG1hdC1vcHRpb24gW3ZhbHVlXT1cIm51bGxcIj48L21hdC1vcHRpb24+XHJcbiAgICAgICAgICAgICAgPG1hdC1vcHRpb24gKm5nRm9yPVwibGV0IGNvbCBvZiBwcmVmaWx0ZXIuZGF0YVwiIFt2YWx1ZV09XCJjb2wudmFsdWVcIj5cclxuICAgICAgICAgICAgICAgIHt7IGNvbC5kZXNjcmlwdGlvbiB9fVxyXG4gICAgICAgICAgICAgIDwvbWF0LW9wdGlvbj5cclxuICAgICAgICAgICAgPC9tYXQtc2VsZWN0PlxyXG4gICAgICAgICAgICA8bWF0LWhpbnRcclxuICAgICAgICAgICAgICBzdHlsZT1cImNvbG9yOiByZWRcIlxyXG4gICAgICAgICAgICAgICpuZ0lmPVwiZm9ybUdyb3VwLmNvbnRyb2xzW3ByZWZpbHRlci5rZXldLnRvdWNoZWQgJiYgZm9ybUdyb3VwLmNvbnRyb2xzW3ByZWZpbHRlci5rZXldLmVycm9yc1wiPlxyXG4gICAgICAgICAgICAgIHt7ICdEVC1CQS5QUkVGSUxURVJTLlJFUVVJUkVEJyB8IHRyYW5zbG9jbyB9fVxyXG4gICAgICAgICAgICA8L21hdC1oaW50PlxyXG4gICAgICAgICAgPC9tYXQtZm9ybS1maWVsZD5cclxuICAgICAgICAgIDxiciAvPlxyXG4gICAgICAgIDwvbmctY29udGFpbmVyPlxyXG4gICAgICA8L21hdC10b29sYmFyPlxyXG4gICAgPC9uZy1jb250YWluZXI+XHJcbiAgPC9tYXQtZGlhbG9nLWNvbnRlbnQ+XHJcblxyXG4gIDxtYXQtZGlhbG9nLWFjdGlvbnMgYWxpZ249XCJlbmRcIj5cclxuICAgIDxidXR0b24gbWF0LWJ1dHRvbiB0eXBlPVwic3VibWl0XCI+XHJcbiAgICAgIHt7ICdEVC1CQS5GSUxURVJWJyB8IHRyYW5zbG9jbyB9fVxyXG4gICAgPC9idXR0b24+XHJcbiAgPC9tYXQtZGlhbG9nLWFjdGlvbnM+XHJcbjwvZm9ybT5cclxuIl19